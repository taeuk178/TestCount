#!/bin/bash

# Feature Module ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# Usage: create-feature FeatureName [options]

# ìƒ‰ìƒ ì •ì˜
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ê¸°ë³¸ê°’
FEATURE_NAME=""
TARGET_PATH="."
API_ENDPOINT=""
AUTHOR=$(id -F)
DATE=$(date +"%m/%d/%y")
YEAR=$(date +"%Y")

# ë„ì›€ë§ ì¶œë ¥
show_help() {
    echo -e "${BLUE}Feature Module ìƒì„± ìŠ¤í¬ë¦½íŠ¸${NC}"
    echo ""
    echo "ì‚¬ìš©ë²•:"
    echo "  create-feature <FeatureName> [options]"
    echo ""
    echo "ì˜µì…˜:"
    echo "  -p, --path PATH       ìƒì„±í•  ê²½ë¡œ ì§€ì • (ê¸°ë³¸: í˜„ì¬ ë””ë ‰í† ë¦¬)"
    echo "  -a, --api ENDPOINT    API ì—”ë“œí¬ì¸íŠ¸ ê²½ë¡œ (ì˜ˆ: /rest/v1/UserProfile)"
    echo "  -h, --help            ì´ ë„ì›€ë§ í‘œì‹œ"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  create-feature UserProfile"
    echo "  create-feature ExerciseList --path Features/Home/Feature"
    echo "  create-feature UserProfile --api /rest/v1/UserProfile"
    echo ""
}

# ì¸ì íŒŒì‹±
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -p|--path)
            TARGET_PATH="$2"
            shift 2
            ;;
        -a|--api)
            API_ENDPOINT="$2"
            shift 2
            ;;
        *)
            if [ -z "$FEATURE_NAME" ]; then
                FEATURE_NAME="$1"
            else
                echo -e "${RED}ì˜¤ë¥˜: ì•Œ ìˆ˜ ì—†ëŠ” ì¸ì '$1'${NC}"
                show_help
                exit 1
            fi
            shift
            ;;
    esac
done

# Feature Name ê²€ì¦
if [ -z "$FEATURE_NAME" ]; then
    echo -e "${RED}ì˜¤ë¥˜: Feature Nameì„ ì…ë ¥í•´ì£¼ì„¸ìš”${NC}"
    show_help
    exit 1
fi

# API Endpoint ê¸°ë³¸ê°’ ì„¤ì •
if [ -z "$API_ENDPOINT" ]; then
    API_ENDPOINT="/rest/v1/${FEATURE_NAME}"
fi

echo -e "${BLUE}=== Feature Module ìƒì„± ===${NC}\n"
echo -e "${BLUE}Feature Name:${NC} $FEATURE_NAME"
echo -e "${BLUE}ìƒì„± ê²½ë¡œ:${NC} $TARGET_PATH"
echo -e "${BLUE}API Endpoint:${NC} $API_ENDPOINT"
echo ""

# í´ë” ìƒì„±
FEATURE_DIR="$TARGET_PATH/$FEATURE_NAME"

if [ -d "$FEATURE_DIR" ]; then
    echo -e "${YELLOW}ê²½ê³ : '$FEATURE_DIR' í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤${NC}"
    read -p "ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤${NC}"
        exit 1
    fi
fi

mkdir -p "$FEATURE_DIR"
echo -e "${GREEN}âœ“ í´ë” ìƒì„±: $FEATURE_DIR${NC}"

# View íŒŒì¼ ìƒì„±
cat > "$FEATURE_DIR/${FEATURE_NAME}View.swift" << EOF
//
//  ${FEATURE_NAME}View.swift
//  HomeFeature
//
//  Created by $AUTHOR on $DATE.
//

import SwiftUI
import NetworkKit

struct ${FEATURE_NAME}View: View {

    // ViewModel
    @State private var viewModel: ${FEATURE_NAME}ViewModel

    init() {
        // ViewModel ì´ˆê¸°í™”
        let provider = CustomProvider<${FEATURE_NAME}API>()
        let useCase = ${FEATURE_NAME}UseCaseImpl(provider: provider)
        self._viewModel = State(initialValue: ${FEATURE_NAME}ViewModel(useCase: useCase))
    }

    var body: some View {
        ScrollView {
            if viewModel.isLoading && viewModel.data == nil {
                // ì²« ë¡œë”© ì‹œ
                ProgressView("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
                    .padding()
            } else if let errorMessage = viewModel.errorMessage, viewModel.data == nil {
                // ì—ëŸ¬ ì‹œ
                VStack(spacing: 16) {
                    Image(systemName: "exclamationmark.triangle")
                        .font(.system(size: 48))
                        .foregroundStyle(.orange)

                    Text(errorMessage)
                        .foregroundStyle(.secondary)

                    Button("ë‹¤ì‹œ ì‹œë„") {
                        Task {
                            await viewModel.loadData(forceRefresh: true)
                        }
                    }
                }
                .padding()
            } else {
                // ë°ì´í„° í‘œì‹œ
                if let data = viewModel.data {
                    VStack(spacing: 16) {
                        Text("Data loaded successfully")
                        // TODO: Implement your UI here
                    }
                    .padding()
                }
            }
        }
        .navigationTitle("$FEATURE_NAME")
        .navigationBarTitleDisplayMode(.inline)
        .refreshable {
            // Pull-to-refresh
            await viewModel.loadData(forceRefresh: true)
        }
    }
}

// MARK: - Preview

#Preview {
    NavigationStack {
        ${FEATURE_NAME}View()
    }
}
EOF
echo -e "${GREEN}âœ“ ìƒì„±: ${FEATURE_NAME}View.swift${NC}"

# ViewModel íŒŒì¼ ìƒì„±
cat > "$FEATURE_DIR/${FEATURE_NAME}ViewModel.swift" << EOF
//
//  ${FEATURE_NAME}ViewModel.swift
//  HomeFeature
//
//  Created by $AUTHOR on $DATE.
//

import Foundation
import SwiftUI

@Observable
public final class ${FEATURE_NAME}ViewModel {

    // MARK: - Properties

    /// ë°ì´í„°
    public var data: ${FEATURE_NAME}Model?

    /// ë¡œë”© ìƒíƒœ
    public var isLoading: Bool = false

    /// ì—ëŸ¬ ë©”ì‹œì§€
    public var errorMessage: String?

    private let useCase: ${FEATURE_NAME}UseCase

    // MARK: - Initialization

    public init(useCase: ${FEATURE_NAME}UseCase) {
        self.useCase = useCase

        Task {
            await loadData()
        }
    }

    // MARK: - Business Logic

    /// ë°ì´í„° ë¡œë“œ
    @MainActor
    public func loadData(forceRefresh: Bool = false) async {
        errorMessage = nil
        isLoading = true

        do {
            if let model = try await useCase.execute() {
                data = model
                print("âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
            } else {
                errorMessage = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            }
        } catch {
            print("âŒ API í˜¸ì¶œ ì‹¤íŒ¨: \(error)")
            errorMessage = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
        }

        isLoading = false
    }
}
EOF
echo -e "${GREEN}âœ“ ìƒì„±: ${FEATURE_NAME}ViewModel.swift${NC}"

# UseCase íŒŒì¼ ìƒì„±
cat > "$FEATURE_DIR/${FEATURE_NAME}UseCase.swift" << EOF
//
//  ${FEATURE_NAME}UseCase.swift
//  HomeFeature
//
//  Created by $AUTHOR on $DATE.
//

import Foundation
import NetworkKit

public protocol ${FEATURE_NAME}UseCase {
    func execute() async throws -> ${FEATURE_NAME}Model?
}

public final class ${FEATURE_NAME}UseCaseImpl: ${FEATURE_NAME}UseCase {

    private let provider: CustomProvider<${FEATURE_NAME}API>

    public init(provider: CustomProvider<${FEATURE_NAME}API>) {
        self.provider = provider
    }

    public func execute() async throws -> ${FEATURE_NAME}Model? {
        let response: [${FEATURE_NAME}Model] = try await provider.requestMethod(.fetch)
        return response.first
    }
}
EOF
echo -e "${GREEN}âœ“ ìƒì„±: ${FEATURE_NAME}UseCase.swift${NC}"

# Model íŒŒì¼ ìƒì„±
cat > "$FEATURE_DIR/${FEATURE_NAME}Model.swift" << EOF
//
//  ${FEATURE_NAME}Model.swift
//  HomeFeature
//
//  Created by $AUTHOR on $DATE.
//

import Foundation

public struct ${FEATURE_NAME}Model: Codable {
    // TODO: Add your model properties here
    // Example:
    // public let id: String
    // public let name: String
}
EOF
echo -e "${GREEN}âœ“ ìƒì„±: ${FEATURE_NAME}Model.swift${NC}"

# API íŒŒì¼ ìƒì„±
cat > "$FEATURE_DIR/${FEATURE_NAME}API.swift" << EOF
//
//  ${FEATURE_NAME}API.swift
//  HomeFeature
//
//  Created by $AUTHOR on $DATE.
//

import Foundation
import Moya
import NetworkKit

public enum ${FEATURE_NAME}API {
    case fetch
}

extension ${FEATURE_NAME}API: TargetType {
    public var baseURL: URL {
        return SupabaseManager.baseUrl
    }

    public var path: String {
        switch self {
        case .fetch:
            return "$API_ENDPOINT"
        }
    }

    public var method: Moya.Method {
        switch self {
        case .fetch:
            return .get
        }
    }

    public var task: Task {
        switch self {
        case .fetch:
            return .requestPlain
        }
    }

    public var headers: [String: String]? {
        return [
            "apikey": SupabaseManager.apiKey,
            "Authorization": "Bearer \(SupabaseManager.apiKey)",
            "Content-Type": "application/json"
        ]
    }
}
EOF
echo -e "${GREEN}âœ“ ìƒì„±: ${FEATURE_NAME}API.swift${NC}"

# ì™„ë£Œ ë©”ì‹œì§€
echo ""
echo -e "${GREEN}=== ìƒì„± ì™„ë£Œ! ===${NC}\n"
echo -e "${BLUE}ìƒì„±ëœ íŒŒì¼:${NC}"
echo "  $FEATURE_DIR/"
echo "  â”œâ”€â”€ ${FEATURE_NAME}View.swift"
echo "  â”œâ”€â”€ ${FEATURE_NAME}ViewModel.swift"
echo "  â”œâ”€â”€ ${FEATURE_NAME}UseCase.swift"
echo "  â”œâ”€â”€ ${FEATURE_NAME}Model.swift"
echo "  â””â”€â”€ ${FEATURE_NAME}API.swift"
echo ""
echo -e "${BLUE}ë‹¤ìŒ ë‹¨ê³„:${NC}"
echo "1. ${FEATURE_NAME}Model.swiftì— í•„ìš”í•œ ì†ì„± ì¶”ê°€"
echo "2. ${FEATURE_NAME}View.swiftì— UI êµ¬í˜„"
echo "3. Xcodeì—ì„œ í”„ë¡œì íŠ¸ì— íŒŒì¼ë“¤ ì¶”ê°€"
echo ""
echo -e "${GREEN}í–‰ë³µí•œ ì½”ë”© ë˜ì„¸ìš”! ğŸš€${NC}"
